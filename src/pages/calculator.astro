---
// src/pages/calculator.astro - Calculator Page
import Layout from '../layouts/Layout.astro';
---

<Layout title="Spanish Property Calculator">
  <div class="calculator">
    <h1>Spanish Property Calculator</h1>
    
    <form id="calculator-form">
      <div class="form-grid">
        <div class="form-group">
          <label for="propertyValue">Property Value (€)</label>
          <input type="number" id="propertyValue" name="propertyValue" placeholder="300000" required>
        </div>
        
        <div class="form-group">
          <label for="downPayment">Down Payment (%)</label>
          <input type="number" id="downPayment" name="downPayment" placeholder="20" min="0" max="100" required>
        </div>
        
        <div class="form-group">
          <label for="monthlyRent">Monthly Rent (€)</label>
          <input type="number" id="monthlyRent" name="monthlyRent" placeholder="1200" required>
        </div>
        
        <div class="form-group">
          <label for="interestRate">Mortgage Interest Rate (%)</label>
          <input type="number" id="interestRate" name="interestRate" placeholder="3.5" step="0.1" required>
        </div>
        
        <div class="form-group">
          <label for="loanTerm">Loan Term (years)</label>
          <select id="loanTerm" name="loanTerm" required>
            <option value="15">15 years</option>
            <option value="20">20 years</option>
            <option value="25" selected>25 years</option>
            <option value="30">30 years</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="yearsToStay">How long will you stay? (years)</label>
          <input type="number" id="yearsToStay" name="yearsToStay" placeholder="5" min="1" required>
        </div>
        
        <div class="form-group">
          <label for="availableFunds">Available Funds (€)</label>
          <input type="number" id="availableFunds" name="availableFunds" placeholder="100000" required>
        </div>
        
        <div class="form-group">
          <label for="furnitureBudget">Furniture Budget (€)</label>
          <input type="number" id="furnitureBudget" name="furnitureBudget" placeholder="15000">
        </div>
      </div>
      
      <button type="submit" class="calculate-btn">Calculate</button>
    </form>
    
    <div id="results" class="results" style="display: none;">
      <div class="result-section">
        <h4>Purchase Costs</h4>
        <div class="result-item">
          <span class="result-label">Property Value:</span>
          <span class="result-value" id="displayPropertyValue">€0</span>
        </div>
        <div class="result-item">
          <span class="result-label">Down Payment:</span>
          <span class="result-value" id="displayDownPayment">€0</span>
        </div>
        <div class="result-item">
          <span class="result-label">Transfer Tax (10%):</span>
          <span class="result-value" id="displayTransferTax">€0</span>
        </div>
        <div class="result-item">
          <span class="result-label">Notary & Legal Fees:</span>
          <span class="result-value" id="displayLegalFees">€0</span>
        </div>
        <div class="result-item">
          <span class="result-label">Total Purchase Cost:</span>
          <span class="result-value" id="displayTotalCost">€0</span>
        </div>
      </div>

      <div class="result-section">
        <h4>Monthly Costs</h4>
        <div class="result-item">
          <span class="result-label">Monthly Mortgage:</span>
          <span class="result-value" id="displayMonthlyMortgage">€0</span>
        </div>
        <div class="result-item">
          <span class="result-label">Monthly Rent (Alternative):</span>
          <span class="result-value" id="displayMonthlyRent">€0</span>
        </div>
        <div class="result-item">
          <span class="result-label">Monthly Savings (Buy vs Rent):</span>
          <span class="result-value" id="displayMonthlySavings">€0</span>
        </div>
      </div>

      <div class="result-section">
        <h4>Affordability Analysis</h4>
        <div class="result-item">
          <span class="result-label">Total Funds Available:</span>
          <span class="result-value" id="displayAvailableFunds">€0</span>
        </div>
        <div class="result-item">
          <span class="result-label">Total Cost (Inc. Furniture):</span>
          <span class="result-value" id="displayTotalWithFurniture">€0</span>
        </div>
        <div class="result-item">
          <span class="result-label">Surplus/Shortfall:</span>
          <span class="result-value" id="displayAffordability">€0</span>
        </div>
      </div>

      <div class="recommendation" id="recommendation">
        <h4>Recommendation</h4>
        <p id="recommendationText">Calculate to see our recommendation</p>
      </div>
    </div>
  </div>
</Layout>

<script>
document.getElementById('calculator-form').addEventListener('submit', function(e) {
  e.preventDefault();
  
  // Get values
  const propertyValue = parseFloat(document.getElementById('propertyValue').value);
  const downPaymentPercent = parseFloat(document.getElementById('downPayment').value);
  const monthlyRent = parseFloat(document.getElementById('monthlyRent').value);
  const interestRate = parseFloat(document.getElementById('interestRate').value) / 100;
  const loanTerm = parseInt(document.getElementById('loanTerm').value);
  const yearsToStay = parseInt(document.getElementById('yearsToStay').value);
  const availableFunds = parseFloat(document.getElementById('availableFunds').value);
  const furnitureBudget = parseFloat(document.getElementById('furnitureBudget').value) || 0;
  
  // Calculate costs
  const downPayment = propertyValue * (downPaymentPercent / 100);
  const loanAmount = propertyValue - downPayment;
  const transferTax = propertyValue * 0.10; // 10% transfer tax in Spain
  const legalFees = propertyValue * 0.015; // 1.5% for notary and legal fees
  const totalPurchaseCost = downPayment + transferTax + legalFees;
  const totalWithFurniture = totalPurchaseCost + furnitureBudget;
  
  // Calculate monthly mortgage payment
  const monthlyRate = interestRate / 12;
  const numberOfPayments = loanTerm * 12;
  const monthlyMortgage = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) / (Math.pow(1 + monthlyRate, numberOfPayments) - 1);
  
  // Calculate savings
  const monthlySavings = monthlyRent - monthlyMortgage;
  const affordability = availableFunds - totalWithFurniture;
  
  // Update display
  document.getElementById('displayPropertyValue').textContent = '€' + propertyValue.toLocaleString();
  document.getElementById('displayDownPayment').textContent = '€' + downPayment.toLocaleString();
  document.getElementById('displayTransferTax').textContent = '€' + transferTax.toLocaleString();
  document.getElementById('displayLegalFees').textContent = '€' + legalFees.toLocaleString();
  document.getElementById('displayTotalCost').textContent = '€' + totalPurchaseCost.toLocaleString();
  document.getElementById('displayMonthlyMortgage').textContent = '€' + monthlyMortgage.toLocaleString();
  document.getElementById('displayMonthlyRent').textContent = '€' + monthlyRent.toLocaleString();
  document.getElementById('displayMonthlySavings').textContent = '€' + monthlySavings.toLocaleString();
  document.getElementById('displayAvailableFunds').textContent = '€' + availableFunds.toLocaleString();
  document.getElementById('displayTotalWithFurniture').textContent = '€' + totalWithFurniture.toLocaleString();
  document.getElementById('displayAffordability').textContent = '€' + affordability.toLocaleString();
  
  // Recommendation logic
  let recommendation = '';
  if (affordability < 0) {
    recommendation = 'RENT - You need €' + Math.abs(affordability).toLocaleString() + ' more to buy this property.';
  } else if (monthlySavings > 0) {
    recommendation = 'BUY - You\'ll save €' + monthlySavings.toLocaleString() + ' per month compared to renting.';
  } else {
    recommendation = 'CONSIDER CAREFULLY - Buying costs €' + Math.abs(monthlySavings).toLocaleString() + ' more per month than renting.';
  }
  
  document.getElementById('recommendationText').textContent = recommendation;
  document.getElementById('results').style.display = 'block';
});
</script>
